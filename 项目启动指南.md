# APITable 项目启动指南

## 项目概述

APITable 是一个支持实时协作的可视化数据库产品，具有以下核心特征：
- **实时协作** - 支持多用户同时编辑
- **可视化** - 提供直观的数据操作界面
- **数据库** - 强大的数据存储和查询能力

## 环境要求

### 必需软件及版本

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Git | 2.49.0+ | 版本控制 |
| Node.js | 16.15.0 | 使用nvm安装推荐 |
| pnpm | 8.15.9 | 包管理器 |
| Java | OpenJDK 17.0.15+ | 后端服务 |
| Python | 3.13+ | 构建工具 |
| Docker Desktop | 4.40.0+ | 容器化部署 |

> ⚠️ **重要**: Node.js和pnpm版本必须严格按照要求，否则`pnpm install`会报错

### 环境检查命令

```bash
# 检查各软件版本
node --version    # 应显示 v16.15.0
pnpm --version    # 应显示 8.15.9
java --version    # 应显示 OpenJDK 17.x
python3 --version # 应显示 Python 3.13.x
docker --version  # 应显示 Docker 24.x+
```

## 详细启动步骤

### 步骤1: 环境检查

首先检查所有必需的环境依赖是否已正确安装：

```bash
# 检查环境依赖
node --version && pnpm --version && java --version && docker --version
```

**预期输出：**
```
v16.15.0
8.15.9
openjdk 17.0.2 2022-01-18
OpenJDK Runtime Environment (build 17.0.2+8-86)
OpenJDK 64-Bit Server VM (build 17.0.2+8-86, mixed mode, sharing)
Docker version 24.0.6, build ed223bc
```

### 步骤2: 检查环境配置文件

确认项目根目录下存在必要的环境配置文件：

```bash
ls -la | grep -E "\.env"
```

**预期输出：**
```
-rw-r--r--@   1 karekin  staff     2518 Oct  4 23:20 .env
-rw-r--    1 karekin  staff      670 Oct  4 23:13 .env.devenv
```

### 步骤3: 启动数据环境

启动所有必需的数据服务（MySQL、Redis、RabbitMQ、MinIO）：

```bash
make dataenv
```

**预期输出：**
```
mkdir -p ./.data/mysql \
        ./.data/minio/data \
        ./.data/minio/config \
        ./.data/redis \
        ./.data/rabbitmq \

docker compose --env-file .env -p apitable-devenv -f docker-compose.yaml -f docker-compose.dataenv.yaml up -d mysql minio redis rabbitmq init-db init-appdata   
[+] Running 6/6
 ✔ init-db Pulled                                                         39.0s 
 ✔ minio Pulled                                                           39.0s 
 ✔ redis Pulled                                                           39.0s 
 ✔ mysql Pulled                                                           39.0s 
 ✔ rabbitmq Pulled                                                        39.0s 
 ✔ init-appdata Pulled                                                    39.0s
[+] Building 0.0s (0/0)                                    docker:desktop-linux
[+] Running 6/6
 ✔ Container redis                           Started                      10.2s 
 ✔ Container mysql                           Healthy                       4.5s 
 ✔ Container minio                           Started                       0.8s 
 ✔ Container rabbitmq                        Start...                      6.5s 
 ✔ Container apitable-devenv-init-db-1       Exited                        0.1s 
 ✔ Container apitable-devenv-init-appdata-1  Started                       0.0s 
```

### 步骤4: 安装项目依赖

安装所有前端和后端依赖：

```bash
pnpm install
```

**预期输出：**
```
Scope: all 8 workspace projects
Lockfile is up to date, resolution step is skipped
Packages: +3956
...
Done in 51.2s
```

### 步骤5: 构建前端包

构建核心组件和图标包：

```bash
pnpm build:pre
```

**预期输出：**
```
> api-table-easy@1.0.0 build:pre /Volumes/karekinSSD1/project/ApiTableEasy
> nx run-many -t build -p  @apitable/core @apitable/icons --parallel=2 && pnpm -F @apitable/components run build                                                

 
    ✔  nx run @apitable/icons:build (5s)
    ✔  nx run @apitable/core:build (10s)

 ——————————————————————————————————————————————————————————————————————————————

 >  NX   Successfully ran target build for 2 projects (10s)
 

> @apitable/components@1.13.0 build /Volumes/karekinSSD1/project/ApiTableEasy/packages/components                                                               
> rimraf ./dist && tsc && tsc-alias
```

### 步骤6: 构建其他包

构建API客户端和Widget SDK：

```bash
pnpm build:dst
```

**预期输出：**
```
> api-table-easy@1.0.0 build:dst /Volumes/karekinSSD1/project/ApiTableEasy
> nx run-many -t build -p  @apitable/widget-sdk @apitable/api-client --parallel=2 && pnpm -F @apitable/core run build-cjs                                       

 
    ✔  nx run @apitable/api-client:build (5s)
    ✔  nx run @apitable/widget-sdk:build (6s)

 ——————————————————————————————————————————————————————————————————————————————

 >  NX   Successfully ran target build for 2 projects (6s)
 

> @apitable/core@1.13.0 build-cjs /Volumes/karekinSSD1/project/ApiTableEasy/packages/core                                                                       
> rimraf ./dist && tsc --module commonjs && tsc-alias
```

### 步骤7: 构建Java后端

构建Spring Boot后端服务：

```bash
# 添加执行权限
chmod +x backend-server/gradlew

# 构建后端
cd backend-server && ./gradlew build -x test --stacktrace
```

**预期输出：**
```
Starting a Gradle Daemon, 1 incompatible Daemon could not be reused, use --status for details                                                                   
Configuration on demand is an incubating feature.
...
BUILD SUCCESSFUL in 29s
53 actionable tasks: 49 executed, 4 up-to-date
```

### 步骤8: 启动服务

#### 8.1 启动Backend Server (Java后端)

```bash
echo "1" | make run
```

**预期输出：**
```
Tomcat started on port 8081 (http) with context path '/api/v1'
gRPC Server started, listening on address: *, port: 8083
Started Application in 8.745 seconds (process running for 9.093)
```

#### 8.2 启动Room Server (协同编辑服务)

```bash
echo "2" | make run
```

**预期输出：**
```
[ROOM_SERVER] Info      2025-10-04 23:28:10.746 [Bootstrap] Application[ROOM_SERVER]-Env[development]
[ROOM_SERVER] Info      2025-10-04 23:28:10.746 [Bootstrap] The service is running, please visit it: [ http://127.0.0.1:3333 ]
```

#### 8.3 启动Web Server (前端界面)

```bash
echo "3" | make run
```

**预期输出：**
```
wait  - compiling /login (client and server)...
✔ Client
  Compiled successfully in 477.12ms
✔ Edge-server
✔ Server
  Compiled successfully in 392.69ms
```

## 服务架构

### 核心服务

| 服务 | 端口 | 描述 | 技术栈 | 状态 |
|------|------|------|--------|------|
| backend-server | 8081 | 后端API服务 | Java Spring Boot | ✅ 运行中 |
| room-server | 3333 | 协同编辑服务 | Node.js + NestJS | ✅ 运行中 |
| web-server | 3000 | 前端界面 | Next.js | ✅ 运行中 |
| databus-server | 8625 | 数据总线服务 | Docker容器 | ✅ 运行中 |

### 数据服务

| 服务 | 端口 | 描述 | 管理界面 | 状态 |
|------|------|------|----------|------|
| MySQL | 3306 | 主数据库 | - | ✅ 运行中 |
| Redis | 6379 | 缓存服务 | - | ✅ 运行中 |
| RabbitMQ | 5672, 15672 | 消息队列 | http://localhost:15672 | ✅ 运行中 |
| MinIO | 9000-9001 | 对象存储 | http://localhost:9001 | ✅ 运行中 |

## 访问地址

- **前端界面**: http://localhost:3000
- **后端API**: http://localhost:8081/api/v1
- **协同编辑服务**: http://localhost:3333
- **数据总线服务**: http://localhost:8625
- **RabbitMQ管理**: http://localhost:15672
- **MinIO管理**: http://localhost:9001

## 服务状态检查

### 检查端口监听

```bash
netstat -an | grep LISTEN | grep -E "(8081|3000|3333|8625)"
```

**预期输出：**
```
tcp46      0      0  *.3000                 *.*                    LISTEN     
tcp4       0      0  *.3333                 *.*                    LISTEN     
tcp46      0      0  *.8081                 *.*                    LISTEN     
tcp46      0      0  *.8625                 *.*                    LISTEN     
```

### 检查Docker容器

```bash
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

**预期输出：**
```
NAMES                              STATUS                   PORTS
rabbitmq                           Up 8 minutes             4369/tcp, 0.0.0.0:5671-5672->5671-5672/tcp, 15671/tcp, 15691-15692/tcp, 25672/tcp, 0.0.0.0:15672->15672/tcp
redis                              Up 8 minutes             0.0.0.0:6379->6379/tcp
mysql                              Up 8 minutes (healthy)   0.0.0.0:3306->3306/tcp, 33060/tcp
minio                              Up 8 minutes (healthy)   0.0.0.0:9000-9001->9000-9001/tcp
apitable-devenv-databus-server-1   Up 22 minutes            0.0.0.0:8625->8625/tcp
```

### 检查进程状态

```bash
ps aux | grep -E "(java.*application.jar|node.*server.js|node.*nest)" | grep -v grep
```

**预期输出：**
```
karekin          38198  55.7  0.2 413274960  70480 s011  S+   11:27PM   1:39.34 node /Volumes/karekinSSD1/project/ApiTableEasy/packages/room-server/node_modules/.bin/../@nestjs/cli/bin/nest.js start --watch
karekin          37078   0.5  0.2 422370464  80624 s008  S+   11:27PM   0:42.23 /usr/bin/java -jar application/build/libs/application.jar
karekin          38689   0.3 19.5 474691504 6555728 s013  S+   11:27PM   3:34.38 node --max-old-space-size=10000 server.js
```

## 常见问题解决

### 1. Docker镜像拉取失败

```bash
# 配置国内镜像源
# 编辑 ~/.docker/daemon.json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
```

### 2. Node.js版本不匹配

```bash
# 使用nvm安装指定版本
nvm install 16.15.0
nvm use 16.15.0
```

### 3. 端口冲突

```bash
# 检查端口占用
lsof -i :8081
lsof -i :3000
lsof -i :3333
lsof -i :8625
```

### 4. gradlew权限问题

```bash
# 添加执行权限
chmod +x backend-server/gradlew
```

## 停止服务

### 停止所有Docker容器

```bash
docker compose down
```

### 停止进程服务

```bash
# 查找并终止相关进程
ps aux | grep -E "(java|node|nest)" | grep -v grep
kill -9 <PID>
```

## 开发说明

### 项目结构

1. **backend-server** - 后端服务模块
   - 提供所有数据请求接口
   - 使用MySQL、Redis、RabbitMQ中间件
   - 用户账号信息存储在`apitable_user`表

2. **room-server** - 协同编辑模块
   - 实现实时协作功能
   - 依赖databus-server

3. **web-server** - 前端模块
   - 基于Next.js构建
   - 使用文件路径路由模式
   - 仅4个页面使用SSR，其余为CSR

4. **databus-server** - 数据总线服务
   - 支持协同编辑功能
   - 通过Docker容器运行

### 技术特点

- **前端渲染**: 主要使用CSR(客户端渲染)，少量SSR(服务端渲染)
- **状态管理**: 通过axios发送网络请求调用后端接口
- **实时协作**: 基于WebSocket实现多用户协作

## 故障排除

如果遇到问题，请按以下顺序检查：

1. 确认所有环境依赖版本正确
2. 检查Docker容器是否正常运行
3. 验证端口是否被正确监听
4. 查看服务日志输出
5. 确认环境配置文件存在且正确

## 贡献指南

1. Fork项目
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建Pull Request

---

**启动完成！** 🎉

所有服务已成功启动，您现在可以访问 http://localhost:3000 开始使用APITable了！

